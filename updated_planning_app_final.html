<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Планирование продаж</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #212529;
            background-color: #F8F9FA;
            min-height: 100vh;
        }
        
        /* Base styles that will be overridden by theme classes */
        .aerosollex-theme {
            --primary-color: #216EA7;
            --secondary-color: #6ACD4B;
            --text-color: #2E2E2E;
            --background-color: #FFFFFF;
            --header-background: linear-gradient(90deg, #216EA7 0%, #6ACD4B 100%);
            --card-background: #FFFFFF;
            --button-primary-bg: #216EA7;
            --button-primary-hover: #1a5a8b;
            --accent-gradient: linear-gradient(90deg, #216EA7 0%, #6ACD4B 100%);
        }
        
        .netkanika-theme {
            --primary-color: #E74C3C;
            --secondary-color: #3498DB;
            --text-color: #2C3E50;
            --background-color: #FFFFFF;
            --header-background: #E74C3C;
            --card-background: #FFFFFF;
            --button-primary-bg: #E74C3C;
            --button-primary-hover: #C0392B;
            --accent-gradient: linear-gradient(135deg, #E74C3C 0%, #3498DB 100%);
        }
        
        .talatu-theme {
            --primary-color: #8E44AD;
            --secondary-color: #F39C12;
            --text-color: #2C3E50;
            --background-color: #FFFFFF;
            --header-background: #8E44AD;
            --card-background: #FFFFFF;
            --button-primary-bg: #8E44AD;
            --button-primary-hover: #71368A;
            --accent-gradient: linear-gradient(135deg, #8E44AD 0%, #F39C12 100%);
        }
        
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 32px;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            background: var(--background-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .welcome-content {
            max-width: 600px;
            width: 100%;
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 48px;
            text-align: center;
        }
        
        .welcome-logo {
            width: 120px;
            height: 80px;
            margin: 0 auto 32px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 16px;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: #6C757D;
            margin-bottom: 32px;
        }
        
        .selection-form {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E9ECEF;
            border-radius: 8px;
            font-size: 16px;
            background: var(--background-color);
            color: var(--text-color);
            cursor: pointer;
            transition: border-color 200ms ease;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 110, 167, 0.1);
        }
        
        .btn {
            height: 48px;
            padding: 0 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease-out;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: var(--button-primary-bg);
            color: #FFFFFF;
            width: 100%;
        }
        
        .btn-primary:hover {
            background: var(--button-primary-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 2px solid #E9ECEF;
            width: 100%;
            margin-top: 12px;
        }
        
        .btn-secondary:hover {
            background: #F8F9FA;
            transform: translateY(-1px);
        }
        
        /* Header Styles */
        .header {
            background: var(--header-background);
            color: white;
            border-bottom: none;
            padding: 24px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-logo {
            width: 60px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
        
        .header-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        /* Year Selector */
        .year-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .year-select {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
        }
        
        .year-select option {
            background: var(--primary-color);
            color: white;
        }
        
        /* Button Styles */
        .btn-secondary-light {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-secondary-light:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-primary-light {
            background: white;
            color: var(--primary-color);
        }
        
        .btn-primary-light:hover {
            background: #F8F9FA;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        /* Main Content */
        .main-content {
            padding-top: 32px;
        }
        
        .section {
            margin-bottom: 48px;
        }
        
        .section-title {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .section-subtitle {
            font-size: 16px;
            color: #6C757D;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        
        /* Instructions */
        .instructions {
            background: #EBF5FF;
            border: 1px solid var(--primary-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .instructions h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-color);
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #6C757D;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        /* Business Area Card */
        .business-area-card {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 24px;
            transition: all 250ms ease-out;
            border-top: 4px solid var(--primary-color);
        }
        
        .business-area-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .card-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .budget-type {
            background: var(--accent-gradient);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Data Table */
        .data-table {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #CED4DA;
        }
        
        th {
            background: #F8F9FA;
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #CED4DA;
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
        }
        
        td input:focus {
            outline: none;
            border-color: var(--primary-color);
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(33, 110, 167, 0.2);
        }
        
        td input.error {
            border-color: #DC3545;
        }
        
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .total-row {
            background: #F8F9FA;
            font-weight: 600;
        }
        
        .total-row td input {
            background: #F8F9FA;
            border: none;
            font-weight: 600;
        }
        
        /* Analytics Section */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }
        
        .chart-container {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 24px;
            border-top: 3px solid var(--secondary-color);
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-color);
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 16px 24px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 300ms ease-out;
            border-left: 4px solid var(--primary-color);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left-color: #28A745;
        }
        
        .notification.error {
            border-left-color: #DC3545;
        }
        
        .notification.warning {
            border-left-color: #FFC107;
        }
        
        /* Back Button */
        .back-section {
            margin-bottom: 24px;
        }
        
        .btn-back {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 200ms ease;
        }
        
        .btn-back:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Investment projects responsive styles */
        .project-form {
            background: #F8F9FA;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .project-form > div {
            margin-bottom: 16px;
        }

        .project-form label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .project-form input,
        .project-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #CED4DA;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 200ms ease;
        }

        .project-form input:focus,
        .project-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 110, 167, 0.2);
        }

        .project-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .project-item {
            background: var(--card-background);
            border: 1px solid #CED4DA;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 250ms ease-out;
        }

        .project-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .project-item h4 {
            margin: 0 0 8px 0;
            color: var(--text-color);
            font-size: 18px;
        }

        .project-item h5 {
            margin: 0 0 8px 0;
            color: var(--text-color);
            font-size: 16px;
        }

        .project-item p {
            margin: 0;
            color: #6C757D;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .welcome-content {
                padding: 24px;
                margin: 16px;
            }
            
            .header {
                padding: 16px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .header-left {
                flex-direction: column;
                gap: 8px;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
            }

            .project-form > div {
                grid-template-columns: 1fr;
            }

            .project-form div div div {
                grid-template-columns: repeat(2, 1fr);
            }

            .project-item > div {
                grid-template-columns: 1fr;
            }

            .project-item > div:last-child {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--card-background);
            margin: 5% auto;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .close {
            color: #6C757D;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--text-color);
        }
    </style>
</head>
<body class="aerosollex-theme">
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-content">
            <div class="welcome-logo" id="welcomeLogo">
                ВЫБОР
            </div>
            <h1 class="welcome-title">Планирование продаж</h1>
            <p class="welcome-subtitle">
                Выберите ваше бизнес-направление и вид ревизии бюджета для начала работы
            </p>
            
            <div class="selection-form">
                <div class="form-group">
                    <label class="form-label" for="businessDirection">Бизнес-направление</label>
                    <select id="businessDirection" class="form-select" required>
                        <option value="">Выберите направление...</option>
                        <option value="Диметиловый эфир">Диметиловый эфир</option>
                        <option value="Нетканые материалы">Нетканые материалы</option>
                        <option value="Промышленные покрытия">Промышленные покрытия</option>
                        <option value="Порошковые покрытия">Порошковые покрытия</option>
                        <option value="Покрытия по дереву">Покрытия по дереву</option>
                        <option value="Декоративные покрытия">Декоративные покрытия</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="budgetRevision">Вид ревизии бюджета</label>
                    <select id="budgetRevision" class="form-select" required>
                        <option value="">Выберите вид ревизии...</option>
                        <option value="План 2026 г">План 2026 г</option>
                        <option value="Прогноз 1+11 2026 г">Прогноз 1+11 2026 г</option>
                        <option value="Прогноз 2+10 2026 г">Прогноз 2+10 2026 г</option>
                        <option value="Прогноз 3+9 2026 г">Прогноз 3+9 2026 г</option>
                        <option value="Прогноз 4+8 2026 г">Прогноз 4+8 2026 г</option>
                        <option value="Прогноз 5+7 2026 г">Прогноз 5+7 2026 г</option>
                        <option value="Прогноз 6+6 2026 г">Прогноз 6+6 2026 г</option>
                        <option value="Прогноз 7+5 2026 г">Прогноз 7+5 2026 г</option>
                        <option value="Прогноз 8+4 2026 г">Прогноз 8+4 2026 г</option>
                        <option value="Прогноз 9+3 2026 г">Прогноз 9+3 2026 г</option>
                        <option value="Прогноз 10+2 2026 г">Прогноз 10+2 2026 г</option>
                        <option value="Прогноз 11+1 2026 г">Прогноз 11+1 2026 г</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="scenario">Сценарий</label>
                    <select id="scenario" class="form-select" required>
                        <option value="">Выберите сценарий...</option>
                        <option value="Оптимистичный">Оптимистичный</option>
                        <option value="Реалистичный">Реалистичный</option>
                        <option value="Пессимистичный">Пессимистичный</option>
                    </select>
                </div>
                
                <button id="startPlanning" class="btn btn-primary" disabled>
                    Начать планирование
                </button>
                
                <button id="loadData" class="btn btn-secondary">
                    Загрузить сохраненные данные
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="mainScreen" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo" id="headerLogo">АЭ</div>
                    <div>
                        <h1 id="pageTitle">Планирование продаж</h1>
                        <div class="header-info" id="headerInfo"></div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="year-selector">
                        <label for="yearSelect">Год:</label>
                        <select id="yearSelect" class="year-select">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary-light" onclick="showWelcomeScreen()">Сменить направление</button>
                    <button class="btn btn-secondary-light" onclick="loadSavedData()">Загрузить данные</button>
                    <button class="btn btn-secondary-light" onclick="exportToCSV()">Экспорт в CSV</button>
                    <button class="btn btn-primary-light" onclick="saveAllData()">Сохранить все</button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Back Section -->
            <div class="back-section">
                <button class="btn-back" onclick="showWelcomeScreen()">
                    ← Изменить выбор
                </button>
            </div>
            
            <!-- Instructions -->
            <div class="instructions">
                <h3>Инструкция по использованию</h3>
                <ul>
                    <li><strong>Блок продаж:</strong> Введите данные за каждый месяц года: объем продаж (тонны), цену реализации (руб/кг), сырьевую маржинальность (%)</li>
                    <li><strong>Блок затрат:</strong> Заполните планируемые затраты по статьям на каждый месяц. Итоги рассчитываются автоматически</li>
                    <li><strong>Инвестиционные проекты:</strong> Добавьте проекты с указанием бюджета, графика платежей, цели и экономического эффекта</li>
                    <li>Выручка, маржинальность и итоги по затратам рассчитываются автоматически</li>
                    <li>Используйте кнопку "Сохранить все" для сохранения данных в браузере</li>
                    <li>Экспортируйте данные в CSV для работы в Excel (включает все блоки данных)</li>
                    <li>Графики показывают динамику по месяцам</li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <section class="section">
                    <h2 class="section-title" id="mainTitle">Ввод данных по продажам</h2>
                    <p class="section-subtitle" id="mainSubtitle">
                        Введите плановые показатели продаж на 12 месяцев года.
                        Данные сохраняются автоматически при нажатии кнопки "Сохранить все".
                    </p>

                    <div class="business-area-card" id="businessAreaCard">
                        <!-- Business area content will be generated by JavaScript -->
                    </div>
                </section>

                <!-- Analytics Section -->
                <section class="section">
                    <h2 class="section-title">Аналитика и визуализация</h2>
                    <p class="section-subtitle">
                        Графическое представление данных по выручке и сырьевой маржинальности.
                    </p>
                    
                    <div class="analytics-grid">
                        <div class="chart-container">
                            <h3 class="chart-title">Выручка по месяцам (млн. руб.)</h3>
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 class="chart-title">Сырьевая маржинальность по месяцам (млн. руб.)</h3>
                            <canvas id="marginChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Costs by Direction Section -->
                <section class="section">
                    <h2 class="section-title">Затраты по направлению</h2>
                    <p class="section-subtitle">
                        Планирование затрат по статьям расходов на год.
                    </p>
                    
                    <div class="business-area-card" id="costsCard">
                        <!-- Costs content will be generated by JavaScript -->
                    </div>
                </section>

                <!-- Investment Projects Section -->
                <section class="section">
                    <h2 class="section-title">Инвестиционные проекты</h2>
                    <p class="section-subtitle">
                        Планирование инвестиционных проектов и их экономического эффекта.
                    </p>
                    
                    <div class="business-area-card" id="investmentCard">
                        <!-- Investment projects content will be generated by JavaScript -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modal for Data Loading -->
    <div id="loadDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2 class="modal-title">Загрузка сохраненных данных</h2>
            </div>
            <div id="modalBody">
                <p>Выберите период для загрузки данных:</p>
                <div style="margin: 20px 0;">
                    <label for="loadYearSelect">Год:</label>
                    <select id="loadYearSelect" style="margin-left: 12px; padding: 8px; border: 1px solid #CED4DA; border-radius: 6px;"></select>
                </div>
                <div style="margin: 20px 0;">
                    <label for="loadDirectionSelect">Направление:</label>
                    <select id="loadDirectionSelect" style="margin-left: 12px; padding: 8px; border: 1px solid #CED4DA; border-radius: 6px;"></select>
                </div>
                <div style="margin: 20px 0;">
                    <label for="loadScenarioSelect">Сценарий:</label>
                    <select id="loadScenarioSelect" style="margin-left: 12px; padding: 8px; border: 1px solid #CED4DA; border-radius: 6px;">
                        <option value="">Все сценарии</option>
                        <option value="Оптимистичный">Оптимистичный</option>
                        <option value="Реалистичный">Реалистичный</option>
                        <option value="Пессимистичный">Пессимистичный</option>
                    </select>
                </div>
                <div id="saveList"></div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const MONTHS = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        
        const COST_CATEGORIES = [
            'Расходы на оплату труда',
            'Прочие расходы на персонал',
            'Маркетинг и реклама',
            'Топливо и энергоресурсы',
            'Расходы на ремонт',
            'Расходы на IT, связь',
            'Лабораторные расходы',
            'Информационно-консультационные',
            'Налоги и сборы',
            'Прочие расходы'
        ];
        
        // Corporate themes
        const CORPORATE_THEMES = {
            'Диметиловый эфир': {
                themeClass: 'aerosollex-theme',
                logoSVG: 'logos/aerosollex-logo.svg',
                logoText: 'АЭ',
                companyName: 'Аэрозолекс'
            },
            'Нетканые материалы': {
                themeClass: 'netkanika-theme',
                logoSVG: 'logos/netkanika-logo.svg',
                logoText: 'НМ',
                companyName: 'Нетканика'
            },
            'Промышленные покрытия': {
                themeClass: 'talatu-theme',
                logoSVG: 'logos/talatu-logo.svg',
                logoText: 'ТЛ',
                companyName: 'Талату'
            },
            'Порошковые покрытия': {
                themeClass: 'talatu-theme',
                logoSVG: 'logos/talatu-logo.svg',
                logoText: 'ТЛ',
                companyName: 'Талату'
            },
            'Покрытия по дереву': {
                themeClass: 'talatu-theme',
                logoSVG: 'logos/talatu-logo.svg',
                logoText: 'ТЛ',
                companyName: 'Талату'
            },
            'Декоративные покрытия': {
                themeClass: 'talatu-theme',
                logoSVG: 'logos/talatu-logo.svg',
                logoText: 'ТЛ',
                companyName: 'Талату'
            }
        };
        
        // Application state
        let currentYear = 2026;
        let selectedDirection = '';
        let selectedBudgetRevision = '';
        let selectedScenario = '';
        let savedData = {};
        let revenueChart, marginChart;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            setupWelcomeScreen();
        });
        
        // Setup welcome screen
        function setupWelcomeScreen() {
            const businessDirection = document.getElementById('businessDirection');
            const budgetRevision = document.getElementById('budgetRevision');
            const scenario = document.getElementById('scenario');
            const startButton = document.getElementById('startPlanning');
            
            function checkFormCompletion() {
                startButton.disabled = !(businessDirection.value && budgetRevision.value && scenario.value);
            }
            
            function updateWelcomeLogo() {
                const welcomeLogo = document.getElementById('welcomeLogo');
                if (businessDirection.value) {
                    const theme = CORPORATE_THEMES[businessDirection.value];
                    if (theme.logoSVG) {
                        welcomeLogo.innerHTML = `<img src="${theme.logoSVG}" alt="${theme.companyName}" style="width: 100px; height: 60px; object-fit: contain;">`;
                    } else {
                        welcomeLogo.textContent = theme.logoText;
                    }
                } else {
                    welcomeLogo.innerHTML = 'ВЫБОР';
                }
            }
            
            businessDirection.addEventListener('change', function() {
                checkFormCompletion();
                updateWelcomeLogo();
            });
            budgetRevision.addEventListener('change', checkFormCompletion);
            scenario.addEventListener('change', checkFormCompletion);
            
            document.getElementById('startPlanning').addEventListener('click', function() {
                selectedDirection = businessDirection.value;
                selectedBudgetRevision = budgetRevision.value;
                selectedScenario = scenario.value;
                applyCorporateTheme();
                showMainScreen();
            });
        }
        
        // Apply corporate theme
        function applyCorporateTheme() {
            const theme = CORPORATE_THEMES[selectedDirection];
            
            // Remove all theme classes
            document.body.className = '';
            // Add new theme class
            document.body.classList.add(theme.themeClass);
            
            // Update header logo with SVG
            const headerLogo = document.getElementById('headerLogo');
            if (theme.logoSVG) {
                headerLogo.innerHTML = `<img src="${theme.logoSVG}" alt="${theme.companyName}" style="width: 60px; height: 40px; object-fit: contain;">`;
            } else {
                headerLogo.textContent = theme.logoText;
            }
            
            // Update page titles
            document.getElementById('pageTitle').textContent = `Планирование продаж - ${theme.companyName}`;
            document.getElementById('headerInfo').textContent = `${selectedDirection} | ${selectedBudgetRevision} | ${selectedScenario}`;
            document.getElementById('mainTitle').textContent = `Ввод данных: ${selectedDirection}`;
            document.getElementById('mainSubtitle').textContent = `Введите плановые показатели продаж для направления "${selectedDirection}" по виду ревизии "${selectedBudgetRevision}" (сценарий: ${selectedScenario}). Данные сохраняются при нажатии кнопки "Сохранить все".`;
        }
        
        // Show main screen
        function showMainScreen() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            
            setupMainScreen();
        }
        
        // Show welcome screen
        function showWelcomeScreen() {
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'flex';
            
            // Reset form
            document.getElementById('businessDirection').value = '';
            document.getElementById('budgetRevision').value = '';
            document.getElementById('scenario').value = '';
            document.getElementById('startPlanning').disabled = true;
        }
        
        // Setup main screen
        function setupMainScreen() {
            setupYearSelector();
            createBusinessAreaCard();
            createCostsCard();
            createInvestmentCard();
            setupEventListeners();
            loadSavedDataList();
            updateCharts();
            setupCustomCostEvents();
        }
        
        // Setup event listeners for custom cost categories
        function setupCustomCostEvents() {
            const newCostInput = document.getElementById('newCostCategory');
            if (newCostInput) {
                newCostInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomCost();
                    }
                });
            }
        }
        
        // Setup year selector
        function setupYearSelector() {
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.addEventListener('change', function() {
                currentYear = parseInt(this.value);
                createBusinessAreaCard();
                createCostsCard();
                createInvestmentCard();
                updateCharts();
            });
        }
        
        // Create business area card
        function createBusinessAreaCard() {
            const card = document.getElementById('businessAreaCard');
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="card-title">${selectedDirection}</h3>
                    <div class="budget-type">${selectedBudgetRevision} | ${selectedScenario}</div>
                </div>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Месяц</th>
                                <th>Объем продаж (т)</th>
                                <th>Цена (руб/кг)</th>
                                <th>Маржинальность (%)</th>
                                <th>Выручка (млн. руб.)</th>
                                <th>Маржа (млн. руб.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${MONTHS.map(month => `
                                <tr data-month="${month}">
                                    <td><strong>${month}</strong></td>
                                    <td><input type="number" step="0.01" min="0" placeholder="0" data-type="volume"></td>
                                    <td><input type="number" step="0.01" min="0" placeholder="0" data-type="price"></td>
                                    <td><input type="number" step="0.01" min="0" max="100" placeholder="0" data-type="margin"></td>
                                    <td><span class="calculated" data-type="revenue">0.00</span></td>
                                    <td><span class="calculated" data-type="calculated-margin">0.00</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td><strong>Итого за год</strong></td>
                                <td><span class="total" data-total="volume">0.00</span></td>
                                <td><span class="total" data-total="avg-price">0.00</span></td>
                                <td><span class="total" data-total="avg-margin">0.00</span></td>
                                <td><span class="total" data-total="revenue">0.00</span></td>
                                <td><span class="total" data-total="calculated-margin">0.00</span></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        // Create costs card
        function createCostsCard() {
            const card = document.getElementById('costsCard');
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="card-title">Планирование затрат на ${currentYear} год</h3>
                    <div class="budget-type">${selectedDirection}</div>
                </div>
                <div class="data-table">
                    <table id="costsTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">N пп</th>
                                <th style="width: 250px;">Статья затрат</th>
                                <th style="width: 80px;">Ед изм</th>
                                ${MONTHS.map(month => `<th style="width: 80px;">${month.slice(0, 3)}</th>`).join('')}
                                <th style="width: 100px;">ИТОГО</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${COST_CATEGORIES.map((category, index) => `
                                <tr data-category="${category}">
                                    <td style="text-align: center;"><strong>${index + 1}</strong></td>
                                    <td><strong>${category}</strong></td>
                                    <td style="text-align: center;">млн.р</td>
                                    ${MONTHS.map(month => `<td><input type="number" step="0.01" min="0" placeholder="0" data-month="${month}" data-category="${category}" style="text-align: right;"></td>`).join('')}
                                    <td><span class="calculated" data-category-total="${category}">0.00</span></td>
                                </tr>
                            `).join('')}
                            <tr id="customCostsRow">
                                <td colspan="3">
                                    <input type="text" id="newCostCategory" placeholder="Название новой статьи затрат" style="width: 100%; padding: 8px; border: 1px solid #CED4DA; border-radius: 6px;">
                                </td>
                                <td colspan="9" style="text-align: center;">
                                    <button type="button" class="btn btn-secondary-light" style="height: 32px; font-size: 12px; padding: 0 16px; color: var(--text-color);" onclick="addCustomCost()">Добавить статью</button>
                                </td>
                                <td colspan="4" style="text-align: center;">
                                    <input type="text" id="deleteCostCategory" placeholder="Название статьи для удаления" style="width: 100%; padding: 6px; border: 1px solid #CED4DA; border-radius: 6px; font-size: 11px;">
                                    <button type="button" class="btn btn-secondary-light" style="height: 32px; font-size: 12px; padding: 0 16px; color: var(--text-color); margin-top: 4px; background: #FFE6E6; border-color: #FFC0C0;" onclick="deleteCostCategory()">Удалить статью</button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3"><strong>ИТОГО по месяцам</strong></td>
                                ${MONTHS.map(month => `<td><span class="total" data-month-total="${month}">0.00</span></td>`).join('')}
                                <td><span class="total grand-total">0.00</span></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        // Create investment card
        function createInvestmentCard() {
            const card = document.getElementById('investmentCard');
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="card-title">Инвестиционные проекты на ${currentYear} год</h3>
                    <div class="budget-type">${selectedDirection}</div>
                </div>
                <div id="projectsContainer">
                    <div class="project-form" style="background: #F8F9FA; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 16px; color: var(--text-color);">Добавить новый проект</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Название проекта</label>
                                <input type="text" id="projectName" placeholder="Введите название проекта" style="width: 100%; padding: 12px; border: 1px solid #CED4DA; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Бюджет проекта (млн. руб.)</label>
                                <input type="number" id="projectBudget" step="0.01" min="0" placeholder="0" style="width: 100%; padding: 12px; border: 1px solid #CED4DA; border-radius: 6px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Порядок оплаты</label>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                ${MONTHS.map(month => `
                                    <div>
                                        <label style="display: block; font-size: 12px; margin-bottom: 4px;">${month.slice(0, 3)}</label>
                                        <input type="number" id="payment_${month}" step="0.01" min="0" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #CED4DA; border-radius: 4px; font-size: 12px;">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Цель проекта</label>
                            <textarea id="projectGoal" placeholder="Опишите цель проекта" rows="3" style="width: 100%; padding: 12px; border: 1px solid #CED4DA; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Экономический эффект</label>
                            <textarea id="projectEffect" placeholder="Опишите ожидаемый экономический эффект" rows="3" style="width: 100%; padding: 12px; border: 1px solid #CED4DA; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <button type="button" class="btn btn-primary-light" onclick="addProject()">Добавить проект</button>
                    </div>
                    <div id="projectsList">
                        <!-- Projects will be listed here -->
                    </div>
                </div>
            `;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Input validation and calculations for main sales table
            document.addEventListener('input', function(e) {
                if (e.target.matches('input[data-type]')) {
                    validateInput(e.target);
                    calculateRow(e.target.closest('tr'));
                    calculateTotals();
                    updateCharts();
                }
                
                // Handle costs calculations
                if (e.target.matches('input[data-category][data-month]')) {
                    calculateCostTotals();
                }
            });

            // Handle investments calculations
            document.addEventListener('input', function(e) {
                if (e.target.matches('input[id^="payment_"]')) {
                    validateInput(e.target);
                }
            });
        }
        
        // Validate input
        function validateInput(input) {
            const value = parseFloat(input.value) || 0;
            const type = input.getAttribute('data-type');
            
            // Remove previous error state
            input.classList.remove('error');
            
            // Validate based on type
            if (value < 0) {
                input.classList.add('error');
                showNotification('Значение не может быть отрицательным', 'error');
                return false;
            }
            
            if (type === 'margin' && value > 100) {
                input.classList.add('error');
                showNotification('Маржинальность не может превышать 100%', 'error');
                return false;
            }
            
            return true;
        }
        
        // Calculate values for a row
        function calculateRow(row) {
            const volume = parseFloat(row.querySelector('input[data-type="volume"]').value) || 0;
            const price = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
            const margin = parseFloat(row.querySelector('input[data-type="margin"]').value) || 0;
            
            // Calculate revenue (volume in tons * price per kg * 1000 / 1,000,000)
            const revenue = (volume * price * 1000) / 1000000;
            
            // Calculate margin amount
            const marginAmount = (revenue * margin) / 100;
            
            // Update calculated values
            row.querySelector('[data-type="revenue"]').textContent = revenue.toFixed(2);
            row.querySelector('[data-type="calculated-margin"]').textContent = marginAmount.toFixed(2);
        }
        
        // Calculate totals
        function calculateTotals() {
            const rows = document.querySelectorAll('#businessAreaCard tbody tr');
            let totalVolume = 0;
            let totalRevenue = 0;
            let totalMarginAmount = 0;
            
            rows.forEach(row => {
                const volume = parseFloat(row.querySelector('input[data-type="volume"]').value) || 0;
                const price = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                const margin = parseFloat(row.querySelector('input[data-type="margin"]').value) || 0;
                const revenue = (volume * price * 1000) / 1000000;
                const marginAmount = (revenue * margin) / 100;
                
                totalVolume += volume;
                totalRevenue += revenue;
                totalMarginAmount += marginAmount;
            });
            
            // Update totals
            const totals = {
                volume: totalVolume.toFixed(2),
                'avg-price': totalVolume > 0 ? (totalRevenue * 1000000 / (totalVolume * 1000)).toFixed(2) : '0.00',
                'avg-margin': totalRevenue > 0 ? ((totalMarginAmount / totalRevenue) * 100).toFixed(2) : '0.00',
                revenue: totalRevenue.toFixed(2),
                'calculated-margin': totalMarginAmount.toFixed(2)
            };
            
            Object.keys(totals).forEach(key => {
                const element = document.querySelector(`[data-total="${key}"]`);
                if (element) element.textContent = totals[key];
            });
        }

        // Calculate costs totals
        function calculateCostTotals() {
            // Get all cost categories (both predefined and custom)
            const allCategories = [...COST_CATEGORIES];
            
            // Add custom categories from DOM
            const customCategories = Array.from(document.querySelectorAll('#costsTable tbody tr[data-category]'))
                .map(row => row.getAttribute('data-category'))
                .filter(category => !COST_CATEGORIES.includes(category));
            
            allCategories.push(...customCategories);

            // Calculate totals for each category (row totals)
            allCategories.forEach(category => {
                let categoryTotal = 0;
                MONTHS.forEach(month => {
                    const input = document.querySelector(`input[data-category="${category}"][data-month="${month}"]`);
                    const value = parseFloat(input?.value) || 0;
                    categoryTotal += value;
                });
                
                // Update category total
                const totalElement = document.querySelector(`[data-category-total="${category}"]`);
                if (totalElement) totalElement.textContent = categoryTotal.toFixed(2);
            });

            // Calculate totals for each month (column totals)
            let grandTotal = 0;
            MONTHS.forEach(month => {
                let monthTotal = 0;
                allCategories.forEach(category => {
                    const input = document.querySelector(`input[data-category="${category}"][data-month="${month}"]`);
                    const value = parseFloat(input?.value) || 0;
                    monthTotal += value;
                });
                
                // Update month total
                const totalElement = document.querySelector(`[data-month-total="${month}"]`);
                if (totalElement) totalElement.textContent = monthTotal.toFixed(2);
                
                grandTotal += monthTotal;
            });
            
            // Update grand total
            const grandTotalElement = document.querySelector('.grand-total');
            if (grandTotalElement) grandTotalElement.textContent = grandTotal.toFixed(2);
        }

        // Add custom cost category
        function addCustomCost() {
            const newCategoryInput = document.getElementById('newCostCategory');
            const categoryName = newCategoryInput.value.trim();
            
            if (!categoryName) {
                showNotification('Введите название статьи затрат', 'warning');
                return;
            }
            
            // Check if category already exists
            const existingCategory = document.querySelector(`input[data-category="${categoryName}"]`);
            if (existingCategory) {
                showNotification('Такая статья затрат уже существует', 'warning');
                return;
            }
            
            // Find the row before custom costs row
            const customRow = document.getElementById('customCostsRow');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-category', categoryName);
            
            const rowIndex = document.querySelectorAll('#costsTable tbody tr').length;
            
            newRow.innerHTML = `
                <td style="text-align: center;"><strong>${rowIndex}</strong></td>
                <td><strong>${categoryName}</strong></td>
                <td style="text-align: center;">млн.р</td>
                ${MONTHS.map(month => `<td><input type="number" step="0.01" min="0" placeholder="0" data-month="${month}" data-category="${categoryName}" style="text-align: right;"></td>`).join('')}
                <td><span class="calculated" data-category-total="${categoryName}">0.00</span></td>
            `;
            
            customRow.parentNode.insertBefore(newRow, customRow);
            newCategoryInput.value = '';
            showNotification(`Статья затрат "${categoryName}" добавлена`, 'success');
            
            // Renumber all rows
            renumberCostRows();
        }

        // Delete custom cost category
        function deleteCostCategory() {
            const deleteInput = document.getElementById('deleteCostCategory');
            const categoryName = deleteInput.value.trim();
            
            if (!categoryName) {
                showNotification('Введите название статьи затрат для удаления', 'warning');
                return;
            }
            
            // Check if category exists and is custom (not predefined)
            const categoryRow = document.querySelector(`#costsTable tbody tr[data-category="${categoryName}"]`);
            if (!categoryRow) {
                showNotification(`Статья затрат "${categoryName}" не найдена`, 'error');
                return;
            }
            
            // Check if it's a predefined category
            if (COST_CATEGORIES.includes(categoryName)) {
                showNotification(`Нельзя удалить предустановленную статью затрат "${categoryName}"`, 'error');
                return;
            }
            
            // Confirm deletion
            if (confirm(`Вы уверены, что хотите удалить статью затрат "${categoryName}"?`)) {
                categoryRow.remove();
                deleteInput.value = '';
                showNotification(`Статья затрат "${categoryName}" удалена`, 'success');
                
                // Renumber all rows
                renumberCostRows();
                
                // Recalculate totals
                calculateCostTotals();
            }
        }

        // Renumber cost rows
        function renumberCostRows() {
            const rows = document.querySelectorAll('#costsTable tbody tr:not(#customCostsRow)');
            rows.forEach((row, index) => {
                const numberCell = row.querySelector('td');
                if (numberCell) numberCell.innerHTML = `<strong>${index + 1}</strong>`;
            });
        }

        // Add investment project
        function addProject() {
            const name = document.getElementById('projectName').value.trim();
            const budget = parseFloat(document.getElementById('projectBudget').value) || 0;
            const goal = document.getElementById('projectGoal').value.trim();
            const effect = document.getElementById('projectEffect').value.trim();
            
            if (!name) {
                showNotification('Введите название проекта', 'warning');
                return;
            }
            
            if (budget <= 0) {
                showNotification('Введите бюджет проекта', 'warning');
                return;
            }
            
            // Collect payments
            const payments = {};
            let totalPayments = 0;
            MONTHS.forEach(month => {
                const payment = parseFloat(document.getElementById(`payment_${month}`).value) || 0;
                payments[month] = payment;
                totalPayments += payment;
            });
            
            // Create project object
            const project = {
                name,
                budget,
                payments,
                goal,
                effect,
                totalPayments
            };
            
            // Add to projects list
            addProjectToList(project);
            
            // Clear form
            clearProjectForm();
            showNotification(`Проект "${name}" добавлен`, 'success');
        }

        // Add project to list
        function addProjectToList(project) {
            // Calculate total payments if not provided
            if (!project.totalPayments && project.payments) {
                project.totalPayments = Object.values(project.payments).reduce((sum, payment) => sum + payment, 0);
            }
            
            const projectsList = document.getElementById('projectsList');
            const projectId = 'project_' + Date.now();
            
            const projectElement = document.createElement('div');
            projectElement.className = 'project-item';
            projectElement.style.cssText = `
                background: var(--card-background); 
                border: 1px solid #CED4DA; 
                border-radius: 8px; 
                padding: 20px; 
                margin-bottom: 16px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            `;
            
            projectElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: var(--text-color);">${project.name}</h4>
                        <p style="margin: 0; color: #6C757D; font-size: 14px;">Бюджет: ${project.budget.toFixed(2)} млн. руб.</p>
                        <p style="margin: 4px 0 0 0; color: #6C757D; font-size: 14px;">Запланировано: ${project.totalPayments.toFixed(2)} млн. руб.</p>
                    </div>
                    <button type="button" class="btn btn-secondary" style="height: 32px; font-size: 12px; padding: 0 16px;" onclick="removeProject('${projectId}')">Удалить</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5 style="margin: 0 0 8px 0; color: var(--text-color);">Цель проекта:</h5>
                        <p style="margin: 0; color: #6C757D; font-size: 14px; line-height: 1.5;">${project.goal || 'Не указано'}</p>
                    </div>
                    <div>
                        <h5 style="margin: 0 0 8px 0; color: var(--text-color);">Экономический эффект:</h5>
                        <p style="margin: 0; color: #6C757D; font-size: 14px; line-height: 1.5;">${project.effect || 'Не указано'}</p>
                    </div>
                </div>
                <div style="margin-top: 16px;">
                    <h5 style="margin: 0 0 8px 0; color: var(--text-color);">График платежей:</h5>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; font-size: 12px;">
                        ${MONTHS.map(month => `
                            <div style="text-align: center; padding: 4px; background: #F8F9FA; border-radius: 4px;">
                                <div style="font-weight: 600;">${month.slice(0, 3)}</div>
                                <div style="color: var(--primary-color);">${project.payments[month].toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            projectElement.id = projectId;
            projectsList.appendChild(projectElement);
        }

        // Clear project form
        function clearProjectForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('projectBudget').value = '';
            document.getElementById('projectGoal').value = '';
            document.getElementById('projectEffect').value = '';
            MONTHS.forEach(month => {
                document.getElementById(`payment_${month}`).value = '';
            });
        }

        // Remove project
        function removeProject(projectId) {
            if (confirm('Вы уверены, что хотите удалить этот проект?')) {
                const element = document.getElementById(projectId);
                if (element) {
                    element.remove();
                    showNotification('Проект удален', 'success');
                }
            }
        }
        
        // Save all data
        function saveAllData() {
            const allData = {};
            
            // Get data from main sales table
            const cardData = {
                direction: selectedDirection,
                budgetRevision: selectedBudgetRevision,
                scenario: selectedScenario,
                year: currentYear,
                sales: {
                    months: {}
                },
                costs: {
                    categories: {}
                },
                investments: []
            };
            
            // Sales data
            document.querySelectorAll('#businessAreaCard tbody tr').forEach(row => {
                const month = row.getAttribute('data-month');
                const volume = parseFloat(row.querySelector('input[data-type="volume"]').value) || 0;
                const price = parseFloat(row.querySelector('input[data-type="price"]').value) || 0;
                const margin = parseFloat(row.querySelector('input[data-type="margin"]').value) || 0;
                const revenue = parseFloat(row.querySelector('[data-type="revenue"]').textContent) || 0;
                const marginAmount = parseFloat(row.querySelector('[data-type="calculated-margin"]').textContent) || 0;
                
                cardData.sales.months[month] = { volume, price, margin, revenue, marginAmount };
            });
            
            // Costs data
            document.querySelectorAll('#costsTable tbody tr:not(#customCostsRow)').forEach(row => {
                const category = row.getAttribute('data-category');
                if (category) {
                    cardData.costs.categories[category] = {};
                    MONTHS.forEach(month => {
                        const input = row.querySelector(`input[data-month="${month}"]`);
                        const value = parseFloat(input?.value) || 0;
                        cardData.costs.categories[category][month] = value;
                    });
                }
            });
            
            // Investments data
            const investmentsData = collectInvestmentsData();
            cardData.investments = investmentsData;
            
            allData[selectedDirection] = cardData;
            
            // Save to localStorage (now including scenario in the key)
            const saveKey = `sales_planning_${selectedDirection}_${selectedBudgetRevision}_${selectedScenario}_${currentYear}_${Date.now()}`;
            localStorage.setItem(saveKey, JSON.stringify(allData));
            localStorage.setItem(`last_save_${selectedDirection}_${selectedBudgetRevision}_${selectedScenario}_${currentYear}`, saveKey);
            
            showNotification('Данные успешно сохранены!', 'success');
            loadSavedDataList();
        }
        
        // Export to CSV
        function exportToCSV() {
            const salesData = collectAllData();
            const costsData = collectCostsData();
            const investmentsData = collectInvestmentsData();
            
            if (Object.keys(salesData).length === 0 && Object.keys(costsData).length === 0 && investmentsData.length === 0) {
                showNotification('Нет данных для экспорта', 'warning');
                return;
            }
            
            const csvContent = generateExtendedCSV(salesData, costsData, investmentsData);
            const filename = `planning_${selectedDirection.replace(/\s+/g, '_')}_${selectedBudgetRevision.replace(/\s+/g, '_')}_${selectedScenario.replace(/\s+/g, '_')}_${currentYear}.csv`;
            downloadCSV(csvContent, filename);
            showNotification('Данные экспортированы в CSV!', 'success');
        }
        
        // Collect all data from form
        function collectAllData() {
            const data = {};
            
            document.querySelectorAll('#businessAreaCard tbody tr').forEach(row => {
                const month = row.getAttribute('data-month');
                data[month] = {
                    volume: parseFloat(row.querySelector('input[data-type="volume"]').value) || 0,
                    price: parseFloat(row.querySelector('input[data-type="price"]').value) || 0,
                    margin: parseFloat(row.querySelector('input[data-type="margin"]').value) || 0,
                    revenue: parseFloat(row.querySelector('[data-type="revenue"]').textContent) || 0,
                    marginAmount: parseFloat(row.querySelector('[data-type="calculated-margin"]').textContent) || 0
                };
            });
            
            return data;
        }

        // Collect costs data
        function collectCostsData() {
            const data = {};
            
            document.querySelectorAll('#costsTable tbody tr:not(#customCostsRow)').forEach(row => {
                const category = row.getAttribute('data-category');
                if (category) {
                    data[category] = {};
                    MONTHS.forEach(month => {
                        const input = row.querySelector(`input[data-month="${month}"]`);
                        data[category][month] = parseFloat(input?.value) || 0;
                    });
                }
            });
            
            return data;
        }

        // Collect investments data
        function collectInvestmentsData() {
            const data = [];
            
            document.querySelectorAll('.project-item').forEach(projectElement => {
                const name = projectElement.querySelector('h4').textContent;
                const budgetText = projectElement.querySelector('p').textContent;
                const budget = parseFloat(budgetText.match(/Бюджет: ([\d.,]+)/)[1].replace(',', '.')) || 0;
                
                const payments = {};
                projectElement.querySelectorAll('[style*="color: var(--primary-color)"]').forEach((paymentElement, index) => {
                    payments[MONTHS[index]] = parseFloat(paymentElement.textContent) || 0;
                });
                
                const goalText = projectElement.querySelector('h5 + p').textContent;
                const effectText = projectElement.querySelectorAll('h5 + p')[1].textContent;
                
                data.push({
                    name,
                    budget,
                    payments,
                    goal: goalText,
                    effect: effectText
                });
            });
            
            return data;
        }
        
        // Generate CSV content
        function generateCSV(data) {
            const headers = ['Бизнес-направление', 'Вид ревизии', 'Сценарий', 'Месяц', 'Год', 'Объем продаж (т)', 'Цена (руб/кг)', 'Маржинальность (%)', 'Выручка (млн. руб.)', 'Маржа (млн. руб.)'];
            let csv = headers.join(',') + '\n';
            
            Object.entries(data).forEach(([month, values]) => {
                const row = [
                    selectedDirection,
                    selectedBudgetRevision,
                    selectedScenario,
                    month,
                    currentYear,
                    values.volume,
                    values.price,
                    values.margin,
                    values.revenue,
                    values.marginAmount
                ];
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        // Generate extended CSV content
        function generateExtendedCSV(salesData, costsData, investmentsData) {
            let csv = 'БИЗНЕС-ПЛАНИРОВАНИЕ\n';
            csv += `Компания: ${selectedDirection}\n`;
            csv += `Направление: ${selectedDirection}\n`;
            csv += `Вид ревизии: ${selectedBudgetRevision}\n`;
            csv += `Сценарий: ${selectedScenario}\n`;
            csv += `Год: ${currentYear}\n\n`;
            
            // Sales data section
            csv += '1. ДАННЫЕ ПО ПРОДАЖАМ\n';
            csv += 'Месяц,Объем продаж (т),Цена (руб/кг),Маржинальность (%),Выручка (млн. руб.),Маржа (млн. руб.)\n';
            Object.entries(salesData).forEach(([month, values]) => {
                csv += `${month},${values.volume},${values.price},${values.margin},${values.revenue},${values.marginAmount}\n`;
            });
            csv += '\n';
            
            // Costs data section
            csv += '2. ЗАТРАТЫ ПО НАПРАВЛЕНИЮ\n';
            const costHeaders = ['Статья затрат', ...MONTHS, 'Итого'];
            csv += costHeaders.join(',') + '\n';
            
            Object.entries(costsData).forEach(([category, months]) => {
                const row = [category];
                let total = 0;
                MONTHS.forEach(month => {
                    const value = months[month] || 0;
                    row.push(value);
                    total += value;
                });
                row.push(total);
                csv += row.join(',') + '\n';
            });
            csv += '\n';
            
            // Investments data section
            csv += '3. ИНВЕСТИЦИОННЫЕ ПРОЕКТЫ\n';
            csv += 'Название проекта,Бюджет (млн. руб.),Цель проекта,Экономический эффект,';
            csv += MONTHS.map(m => `Платеж ${m}`).join(',') + ',';
            csv += 'Всего запланировано\n';
            
            investmentsData.forEach(project => {
                const payments = Object.values(project.payments);
                const totalPayments = payments.reduce((sum, payment) => sum + payment, 0);
                
                const row = [
                    project.name,
                    project.budget,
                    `"${project.goal.replace(/"/g, '""')}"`,
                    `"${project.effect.replace(/"/g, '""')}"`,
                    ...payments,
                    totalPayments
                ];
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }
        
        // Download CSV file
        function downloadCSV(content, filename) {
            // Add BOM for proper UTF-8 encoding
            const bom = '\uFEFF';
            const csvContent = bom + content;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Load saved data
        function loadSavedData() {
            const modal = document.getElementById('loadDataModal');
            modal.style.display = 'block';
        }
        
        // Load saved data list
        function loadSavedDataList() {
            const saveList = document.getElementById('saveList');
            const yearSelect = document.getElementById('loadYearSelect');
            const directionSelect = document.getElementById('loadDirectionSelect');
            
            // Setup year selector in modal
            yearSelect.innerHTML = '';
            for (let year = 2025; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.selected = year === currentYear;
                yearSelect.appendChild(option);
            }
            
            // Setup direction selector in modal
            directionSelect.innerHTML = '<option value="">Все направления</option>';
            Object.keys(CORPORATE_THEMES).forEach(direction => {
                const option = document.createElement('option');
                option.value = direction;
                option.textContent = direction;
                if (direction === selectedDirection) {
                    option.selected = true;
                }
                directionSelect.appendChild(option);
            });
            
            // Setup scenario selector in modal
            const scenarioSelect = document.getElementById('loadScenarioSelect');
            scenarioSelect.value = selectedScenario;
            
            // Show saves for selected criteria
            showSavesForYear(currentYear, '', selectedScenario);
            
            yearSelect.addEventListener('change', function() {
                showSavesForYear(parseInt(this.value), directionSelect.value, scenarioSelect.value);
            });
            
            directionSelect.addEventListener('change', function() {
                showSavesForYear(parseInt(yearSelect.value), this.value, scenarioSelect.value);
            });

            scenarioSelect.addEventListener('change', function() {
                showSavesForYear(parseInt(yearSelect.value), directionSelect.value, this.value);
            });
        }
        
        // Show saves for selected year and direction
        function showSavesForYear(year, direction = '', scenario = '') {
            const saveList = document.getElementById('saveList');
            const saves = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`sales_planning_${direction ? direction + '_' : ''}`) && 
                    key.includes(`_${year}_`) &&
                    (!scenario || key.includes(`_${scenario}_`))) {
                    saves.push(key);
                }
            }
            
            if (saves.length === 0) {
                saveList.innerHTML = '<p>Сохранений за этот период не найдено</p>';
                return;
            }
            
            saveList.innerHTML = saves.map(key => {
                const parts = key.split('_');
                const direction = parts[2] || 'Неизвестно';
                const revisionParts = parts.slice(3);
                const scenario = revisionParts[revisionParts.length - 2] || 'Неизвестно';
                const revision = revisionParts.slice(0, -2).join(' ');
                const timestamp = parts[parts.length - 1];
                const date = new Date(parseInt(timestamp));
                
                return `<button class="btn btn-secondary" style="margin: 4px; font-size: 12px;" onclick="loadSpecificSave('${key}')">
                    ${direction}<br>${revision}<br>${scenario}<br>${date.toLocaleDateString('ru-RU')} ${date.toLocaleTimeString('ru-RU')}
                </button>`;
            }).join('');
        }
        
        // Load specific save
        function loadSpecificSave(saveKey) {
            const data = JSON.parse(localStorage.getItem(saveKey));
            
            if (!data) {
                showNotification('Ошибка при загрузке данных', 'error');
                return;
            }
            
            // Clear all existing data
            // Clear sales data
            document.querySelectorAll('#businessAreaCard input[type="number"]').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('#businessAreaCard .calculated, #businessAreaCard .total').forEach(element => {
                element.textContent = '0.00';
            });

            // Clear costs data
            document.querySelectorAll('#costsTable input[type="number"]').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('#costsTable .calculated, #costsTable .total').forEach(element => {
                element.textContent = '0.00';
            });

            // Clear investments data
            document.getElementById('projectsList').innerHTML = '';
            
            // Load new data
            const direction = Object.keys(data)[0];
            const areaData = data[direction];
            
            // Load sales data
            if (areaData.sales && areaData.sales.months) {
                Object.entries(areaData.sales.months).forEach(([month, values]) => {
                    const row = document.querySelector(`#businessAreaCard [data-month="${month}"]`);
                    if (!row) return;
                    
                    row.querySelector('input[data-type="volume"]').value = values.volume;
                    row.querySelector('input[data-type="price"]').value = values.price;
                    row.querySelector('input[data-type="margin"]').value = values.margin;
                    
                    // Trigger recalculation
                    calculateRow(row);
                });
            }
            
            // Load costs data
            if (areaData.costs && areaData.costs.categories) {
                Object.entries(areaData.costs.categories).forEach(([category, months]) => {
                    Object.entries(months).forEach(([month, value]) => {
                        let input = document.querySelector(`#costsTable input[data-category="${category}"][data-month="${month}"]`);
                        
                        // If category doesn't exist, add it first
                        if (!input && value > 0) {
                            addCostCategoryForLoad(category);
                            input = document.querySelector(`#costsTable input[data-category="${category}"][data-month="${month}"]`);
                        }
                        
                        if (input) {
                            input.value = value;
                        }
                    });
                });
            }
            
            // Load investments data
            if (areaData.investments && areaData.investments.length > 0) {
                areaData.investments.forEach(project => {
                    addProjectToList(project);
                });
            }
            
            calculateTotals();
            calculateCostTotals();
            updateCharts();
            
            document.getElementById('loadDataModal').style.display = 'none';
            showNotification('Данные успешно загружены!', 'success');
        }

        // Add cost category for loading data
        function addCostCategoryForLoad(categoryName) {
            // Find the row before custom costs row
            const customRow = document.getElementById('customCostsRow');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-category', categoryName);
            
            const rowIndex = document.querySelectorAll('#costsTable tbody tr:not(#customCostsRow)').length;
            
            newRow.innerHTML = `
                <td style="text-align: center;"><strong>${rowIndex + 1}</strong></td>
                <td><strong>${categoryName}</strong></td>
                <td style="text-align: center;">млн.р</td>
                ${MONTHS.map(month => `<td><input type="number" step="0.01" min="0" placeholder="0" data-month="${month}" data-category="${categoryName}" style="text-align: right;"></td>`).join('')}
                <td><span class="calculated" data-category-total="${categoryName}">0.00</span></td>
            `;
            
            customRow.parentNode.insertBefore(newRow, customRow);
            renumberCostRows();
        }
        
        // Update charts
        function updateCharts() {
            const data = collectAllData();
            
            if (Object.keys(data).length === 0) {
                return;
            }
            
            // Prepare data for charts
            const monthlyRevenue = {};
            const monthlyMargin = {};
            
            MONTHS.forEach(month => {
                monthlyRevenue[month] = 0;
                monthlyMargin[month] = 0;
            });
            
            Object.entries(data).forEach(([month, values]) => {
                monthlyRevenue[month] = values.revenue;
                monthlyMargin[month] = values.marginAmount;
            });
            
            // Update or create revenue chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const marginCtx = document.getElementById('marginChart').getContext('2d');
            
            if (revenueChart) revenueChart.destroy();
            if (marginChart) marginChart.destroy();
            
            // Get theme colors
            const theme = CORPORATE_THEMES[selectedDirection];
            const styles = getComputedStyle(document.body);
            const primaryColor = styles.getPropertyValue('--primary-color').trim() || '#007AFF';
            const secondaryColor = styles.getPropertyValue('--secondary-color').trim() || '#28A745';
            
            // Revenue chart
            revenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: 'Выручка (млн. руб.)',
                        data: MONTHS.map(month => monthlyRevenue[month]),
                        backgroundColor: `${primaryColor}80`,
                        borderColor: primaryColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Выручка (млн. руб.)'
                            }
                        }
                    }
                }
            });
            
            // Margin chart
            marginChart = new Chart(marginCtx, {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: 'Сырьевая маржинальность (млн. руб.)',
                        data: MONTHS.map(month => monthlyMargin[month]),
                        backgroundColor: `${secondaryColor}20`,
                        borderColor: secondaryColor,
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Маржинальность (млн. руб.)'
                            }
                        }
                    }
                }
            });
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        // Modal event listeners
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('loadDataModal').style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('loadDataModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>
</html>